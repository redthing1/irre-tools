#ifdef DESKTOP
#include <stdint.h>
#include <stdio.h>
#endif

#include "../lib/corlib.h"
#include "cc20.h"

#define DEMO_DEVICE_RANDOM 0x00005005
#define PLAINTEXT_LEN 128
#define NONCE_SIZE 12

volatile u8 krypto_nonce[NONCE_SIZE] = {0};

int main(int argc, char **argv) {
    u8 krypto_key[] = {0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
                       0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f};

    u8 input[PLAINTEXT_LEN] = {0x41, 0x20, 0x70, 0x61, 0x6e, 0x63, 0x61, 0x6b, 0x65, 0x20, 0x28, 0x6f, 0x72, 0x20, 0x68,
                               0x6f, 0x74, 0x63, 0x61, 0x6b, 0x65, 0x2c, 0x20, 0x67, 0x72, 0x69, 0x64, 0x64, 0x6c, 0x65,
                               0x63, 0x61, 0x6b, 0x65, 0x2c, 0x20, 0x6f, 0x72, 0x20, 0x66, 0x6c, 0x61, 0x70, 0x6a, 0x61,
                               0x63, 0x6b, 0x29, 0x20, 0x69, 0x73, 0x20, 0x61, 0x20, 0x66, 0x6c, 0x61, 0x74, 0x20, 0x63,
                               0x61, 0x6b, 0x65, 0x2c, 0x20, 0x6f, 0x66, 0x74, 0x65, 0x6e, 0x20, 0x74, 0x68, 0x69, 0x6e,
                               0x20, 0x61, 0x6e, 0x64, 0x20, 0x72, 0x6f, 0x75, 0x6e, 0x64, 0x2c, 0x20, 0x70, 0x72, 0x65,
                               0x70, 0x61, 0x72, 0x65, 0x64, 0x20, 0x66, 0x72, 0x6f, 0x6d, 0x20, 0x61, 0x20, 0x73, 0x74,
                               0x61, 0x72, 0x63, 0x68, 0x2d, 0x62, 0x61, 0x73, 0x65, 0x64, 0x20, 0x62, 0x61, 0x74, 0x74,
                               0x65, 0x72, 0x20, 0x74, 0x68, 0x61, 0x74, 0x20};

    u8 encrypt[PLAINTEXT_LEN];
    u8 decrypt[PLAINTEXT_LEN];

    // use rng to generate a random nonce
    u8 *krypto_nonce_ptr = krypto_nonce;
    __device_send(DEMO_DEVICE_RANDOM, (u32)krypto_nonce_ptr, NONCE_SIZE);

    chacha20_xor(krypto_key, 1, krypto_nonce, input, encrypt, PLAINTEXT_LEN);
    chacha20_xor(krypto_key, 1, krypto_nonce, encrypt, decrypt, PLAINTEXT_LEN);

    // check that the encryption and decryption worked
    if (memcmp(input, decrypt, PLAINTEXT_LEN) != 0) {
        return 1;
    }

#ifdef DEBUG
    __DEBUGGER_BREAK();
#endif

    return 0;
}

#include "cc20.c"
